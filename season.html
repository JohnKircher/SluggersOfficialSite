<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Current Season | Super Sluggers League</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="icon" type="image/jpg" href="favicon.jpg" />

  <style>
    #loading-matches {
      font-size: 1rem;
      color: #555;
    }
  
    .spinner::after {
      content: '⏳';
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }
  
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  
</head>
<body>

  <nav class="navbar">
    <div class="nav-content">
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="characters.html">Characters</a></li>
        <li><a href="season.html" class="active">Current Season</a></li>
      </ul>
    </div>
  </nav>

  <button id="adminToggle" style="position:fixed;top:10px;right:10px;z-index:999;display:none;">Toggle Admin Mode</button>
  <div id="adminPanel" style="display:none;"></div>


  <section class="characters-section">
    <div class="season-tabs-scroll">
      <div class="season-tabs">
        <button class="tab active" data-team="Standings">Standings</button>
        <button class="tab" data-team="Matches">Matches</button>

        <button class="tab" data-team="HarryKirch">HarryKirch</button>
        <button class="tab" data-team="BenR">BenR</button>
        <button class="tab" data-team="Carby">Carby</button>
        <button class="tab" data-team="Julian">Julian</button>
        <button class="tab" data-team="Tom">Tom</button>
        <button class="tab" data-team="Kircher">Kircher</button>
        <button class="tab" data-team="Jmo">Jmo</button>
        <button class="tab" data-team="BenT">BenT</button>
      </div>
    </div>

    <!-- Team Characters Content -->
    <div class="season-content" id="Teams">
      <div class="character-grid" id="teamCharacterGrid"></div>
    </div>

    
  </section>

  <script src="scripts/app.js"></script>
  <script>
    // Secret unlock: press Shift + A
    window.addEventListener('keydown', e => {
      if (e.shiftKey && e.key.toLowerCase() === 'a') {
        document.getElementById('adminToggle').style.display = 'block';
      }
    });

    document.getElementById('adminToggle').addEventListener('click', () => {
      const panel = document.getElementById('adminPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (panel.style.display === 'block') renderAdminPanel();
    });

    let editingIndex = null; // Track which match you're editing

    function renderAdminPanel() {
      const panel = document.getElementById('adminPanel');
      const editing = editingIndex !== null ? window.matches[editingIndex] : null;

      panel.innerHTML = `
        <h3>${editing ? 'Edit Match' : 'Add New Match'}</h3>
        <form id="matchForm">
          <input placeholder="Home Team" name="home" value="${editing?.home || ''}">
          <input placeholder="Away Team" name="away" value="${editing?.away || ''}">
          <input placeholder="Score (e.g. 3 - 2)" name="score" value="${editing?.score || ''}">
          <input placeholder="Date (e.g. April 30, 2025, 6:00 PM)" name="date" value="${editing?.date || ''}">
          <input placeholder="assets/stadiums/(name.jpg)" name="stadiumImg" value="${editing?.stadiumImg || ''}">
          <input placeholder="Day/Night" name="day" value="${editing?.day || ''}">
          <input placeholder="MVP" name="mvp" value="${editing?.mvp || ''}">
          <input placeholder="Banned Stadium" name="banned" value="${editing?.banned || ''}">
          <button type="submit">${editing ? 'Update' : 'Add'} Match</button>
          ${editing ? '<button type="button" id="cancelEdit">Cancel</button>' : ''}
        </form>
        <h3>Current Matches</h3>
        <ul id="adminMatchList"></ul>
      `;

      const list = document.getElementById('adminMatchList');
      list.innerHTML = '';
      window.matches.forEach((match, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${match.home} vs ${match.away} — ${match.date}
          <button onclick="editMatch(${idx})">✏️</button>
          <button onclick="deleteMatch(${idx})">❌</button>
        `;
        list.appendChild(li);
      });

      document.getElementById('matchForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const matchData = {
          home: form.home.value,
          away: form.away.value,
          score: form.score.value,
          date: form.date.value,
          stadiumImg: form.stadiumImg.value,
          day: form.day.value,
          mvp: form.mvp.value,
          banned: form.banned.value
        };

        matchData.id = editingIndex !== null ? window.matches[editingIndex].id : Date.now().toString();
        const method = editingIndex !== null ? 'PUT' : 'POST';

        fetch("https://script.google.com/macros/s/AKfycbybAu3zUjcSV9_KU2_jxkoKS316lBA4S8dK2pZftbwxstWyHVk8VuGlwZaxQaH_g2FL/exec", {
          method,
          body: JSON.stringify(matchData)
        }).then(() => {
          editingIndex = null;
          loadMatchesFromAPI().then(renderAdminPanel);
        });

      });

      if (editing) {
        document.getElementById('cancelEdit').addEventListener('click', () => {
          editingIndex = null;
          renderAdminPanel();
        });
      }
    }

    function editMatch(idx) {
      editingIndex = idx;
      renderAdminPanel();
    }

    function deleteMatch(idx) {
      const id = window.matches[idx].id;
      fetch(`https://script.google.com/macros/s/AKfycbybAu3zUjcSV9_KU2_jxkoKS316lBA4S8dK2pZftbwxstWyHVk8VuGlwZaxQaH_g2FL/exec?id=${id}`, {
        method: 'DELETE'
      }).then(() => {
        loadMatchesFromAPI().then(renderAdminPanel);
      });
    }

    window.onload = async () => {
      await loadMatchesFromAPI();

      renderStandings();
      renderMatches(); // run only after data is ready

      document.getElementById("Standings").classList.add("active");

      const teamRosters = {
        HarryKirch: ["Bowser", "Dark Bones", "Dry Bones", "Blue Dry Bones", "Chicken", "Red Koopa Troopa", "Koopa Troopa", "Red Magikoopa", "Carby", "Red Yoshi", "Baby Mario", "Red Koopa Paratroopa", "Ice Cube", "Blooper"],
        BenR: ["King K Rool", "Kritter", "Blue Kritter", "Luigi", "Rizzler", "Blue Shy Guy", "Minion", "Magikoopa", "Lilo", "Toadsworth", "Matt", "KSI", "Dixie Kong"],
        Carby: ["Donkey Kong", "Petey Piranha", "Funky Kong", "Wario", "Yoshi", "Diddy Kong", "Tiny Kong", "Tsitsipas", "Lizzy", "Yellow Magikoopa", "Frozone", "Harry Potter", "Dora"],
        Julian: ["Unc", "Saddam Hussein", "Lara Croft", "Green Shy Guy", "Green Toad", "Green Magikoopa", "Peach", "Koopa Paratroopa", "Monty Mole", "Kim Jong Un", "Black Widow", "Snape", "Green Noki"],
        Tom: ["Birdo", "King Boo", "Daisy", "Kevin G", "Shy Guy", "Baby Daisy", "Miss Hot", "Livvy Dunne", "Dwayne Wade", "Black Shy Guy", "Pink Yoshi", "Baby Luigi", "Goomba"],
        Kircher: ["Wiggler", "Red Kritter", "Brown Kritter", "Waluigi", "Lebron James", "Borat", "Yellow Shy Guy", "Trinity", "Yellow Pianta", "The Penguin", "Lil Wayne", "SemenLad"],
        Jmo: ["Fire Bro", "Boomerang Bro", "Red Pianta", "Mario", "Toad", "Blue Toad", "Toadette", "Purple Toad", "Mr. Incredible", "Baby Peach", "Blue Yoshi", "Handsome Squidward", "Light Blue Yoshi"],
        BenT: ["Bowser Jr", "Hammer Bro", "Green Dry Bones", "Pianta", "Yellow Toad", "Boo", "Mikasa", "Baby DK", "Paragoomba", "Big AJ", "Yellow Yoshi", "Captain Jack", "MJ HeeHee"]
      };

      const teamGrid = document.getElementById('teamCharacterGrid');
      const allCharacters = window.characters || [];

      function renderTeam(team) {
        teamGrid.innerHTML = '';
        const roster = teamRosters[team];
        const teamCharacters = roster.map(name => allCharacters.find(char => char.name === name)).filter(Boolean);

        teamCharacters.forEach(char => {
          const card = document.createElement('div');
          const isCaptain = window.captains?.includes(char.name);
          card.className = 'character-card' + (isCaptain ? ' captain-card' : '');

          const miiInfo = window.miiMeta?.[char.name];
          const badge = miiInfo ? `<div class="mii-badge" style="background-color:${miiInfo.color};">${miiInfo.gender}</div>` : '';

          card.innerHTML = `
            ${badge}
            <img src="${char.image}" alt="${char.name}">
            <h3>${char.name}</h3>
            <p>Class: ${char.class}</p>
            <p class="placeholder-stats">Stats Coming Soon</p>
          `;

          teamGrid.appendChild(card);
        });
      }

      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          const activeTab = document.querySelector(".tab.active");
          if (activeTab) activeTab.classList.remove("active");
          tab.classList.add("active");

          document.querySelectorAll(".season-content").forEach(s => s.classList.remove("active"));
          const tabName = tab.dataset.team;
          if (tabName === "Standings") {
            renderStandings();
            document.getElementById("Standings").classList.add("active");
          } else if (tabName === "Matches") {
            renderMatches();
            document.getElementById("Matches").classList.add("active");
          } else {
            renderTeam(tabName);
            document.getElementById("Teams").classList.add("active");
          }
        });
      });
    };



    function renderStandings() {
      const body = document.getElementById('season3-standings-body');
      body.innerHTML = '';

      const sorted = [...window.season3Standings].sort((a, b) => {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return b.diff - a.diff;
      });

      sorted.forEach((team, i) => {
        const row = document.createElement('tr');
        if (i === 0) row.classList.add('gold-glow');
        else if (i === 1) row.classList.add('gold-glow');
        else if (i === 2) row.classList.add('green-glow');
        else if (i === 3) row.classList.add('green-glow');
        else if (i === 4) row.classList.add('green-glow');
        else if (i === 5) row.classList.add('green-glow');
        else if (i >= sorted.length - 2) row.classList.add('red-glow');

        const pct = (team.wins / (team.wins + team.losses)).toFixed(3);
        row.innerHTML = `
          <td>${team.team}</td>
          <td>${team.wins}</td>
          <td>${team.losses}</td>
          <td>${pct}</td>
          <td>${team.diff > 0 ? '+' : ''}${team.diff}</td>
        `;
        body.appendChild(row);
      });
    }

    function renderMatches() {
      const matchList = document.getElementById('matchList');
      matchList.innerHTML = '';

      window.matches.forEach(match => {
        const card = document.createElement('div');
        card.className = 'match-card';
        card.innerHTML = `
          <img src="${match.stadiumImg}" alt="Stadium">
          ${match.day ? `<div class="stadium-time-label ${match.day.toLowerCase()}">${match.day}</div>` : ''}
          <div class="banned">${match.banned} Banned</div>
          <div class="teams">
            <span>${match.home}</span>
            <span>${match.away}</span>
          </div>
          <div class="score">${match.score || 'TBD'}</div>
          <div class="time">${match.date}</div>
          ${match.mvp ? `<div class="match-mvp">MVP: ${match.mvp}</div>` : ''}
        `;

        matchList.appendChild(card);
      });
    }
  </script>

  <!-- Standings Content -->
  <div class="season-content" id="Standings">
    <h3>Season 3 Standings</h3>
    <table class="standings-table">
      <thead>
        <tr>
          <th>Team</th>
          <th>W</th>
          <th>L</th>
          <th>PCT</th>
          <th>Diff</th>
        </tr>
      </thead>
      <tbody id="season3-standings-body">
        <!-- Filled dynamically -->
      </tbody>
    </table>
  </div>

  <!-- Matches Content -->
  <div id="loading-matches" class="spinner" style="display:none; text-align:center;">Loading...</div>

  
  <div class="season-content" id="Matches">
    <h3>Upcoming & Completed Matches</h3>
    <div id="matchList" class="character-grid match-grid">
      <!-- Match cards will be inserted here -->
    </div>
  </div>

</body>
</html>
