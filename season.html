<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Current Season | Super Sluggers League</title>
  <link rel="stylesheet" href="styles/main.css" />
  <link rel="icon" type="image/jpg" href="favicon.jpg" />

  <style>
    #loading-matches {
      font-size: 1rem;
      color: #555;
    }
  
    .spinner::after {
      content: '‚è≥';
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }
  
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  
</head>
<body>

  <nav class="navbar">
    <div class="nav-content">
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="characters.html">Characters</a></li>
        <li><a href="season.html" class="active">Current Season</a></li>
      </ul>
    </div>
  </nav>

  <button id="adminToggle" style="position:fixed;top:10px;right:10px;z-index:999;display:none;">Toggle Admin Mode</button>
  <div id="adminPanel" style="display:none;"></div>


  <section class="characters-section">
    <div class="season-tabs-scroll">
      <div class="season-tabs">
        <button class="tab active" data-team="Standings">Standings</button>
        <button class="tab" data-team="Matches">Matches</button>
        <!-- In season.html, add this tab button with the others -->
        <button class="tab" data-team="Season3Stats">Season 3 Stats</button>
        <button class="tab" data-team="Car-bones White Van">Car-bones White Van (harrykirch)</button>
        <button class="tab" data-team="Kritter Town USA">Kritter Town USA (benR)</button>
        <button class="tab" data-team="Monkey Mashers">Monkey Mashers (carby)</button>
        <button class="tab" data-team="Unc's Breeding Program">Unc's Breeding Program (julian)</button>
        <button class="tab" data-team="Kevin G's Escort Agency">Kevin G's Escort Agency (tom)</button>
        <button class="tab" data-team="Trinity Triple Threat">Trinity Triple Threat (kircher)</button>
        <button class="tab" data-team="Toadette's Hit List">Toadette's Hit List (jmo)</button>
        <button class="tab" data-team="BenT">BenT</button>
      </div>
    </div>

    <!-- Team Characters Content -->
    <div class="season-content" id="Teams">
      <div class="character-grid" id="teamCharacterGrid"></div>
      <h3 id="teamMatchesHeader" style="margin-top: 30px;"></h3>
      
      
      <div class="character-grid match-grid" id="teamMatchGrid"></div>
    </div>
    

    
  </section>

  <script src="scripts/app.js"></script>
  <script>
    // Secret unlock: press Shift + A
    window.addEventListener('keydown', e => {
      if (e.shiftKey && e.key.toLowerCase() === 'a') {
        document.getElementById('adminToggle').style.display = 'block';
      }
    });

    document.getElementById('adminToggle').addEventListener('click', () => {
      const panel = document.getElementById('adminPanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      if (panel.style.display === 'block') renderAdminPanel();
    });

    let editingIndex = null; // Track which match you're editing

    function renderAdminPanel() {
      const panel = document.getElementById('adminPanel');
      const editing = editingIndex !== null ? window.matches[editingIndex] : null;

      panel.innerHTML = `
        <h3>${editing ? 'Edit Match' : 'Add New Match'}</h3>
        <form id="matchForm">
          <input placeholder="Home Team" name="home" value="${editing?.home || ''}">
          <input placeholder="Away Team" name="away" value="${editing?.away || ''}">
          <input placeholder="Score (e.g. 3 - 2)" name="score" value="${editing?.score || ''}">
          <input placeholder="Date (e.g. April 30, 2025, 6:00 PM)" name="date" value="${editing?.date || ''}">
          <input placeholder="assets/stadiums/(name.jpg)" name="stadiumImg" value="${editing?.stadiumImg || ''}">
          <input placeholder="Day/Night" name="day" value="${editing?.day || ''}">
          <input placeholder="MVP" name="mvp" value="${editing?.mvp || ''}">
          <input placeholder="Banned Stadium" name="banned" value="${editing?.banned || ''}">
          <button type="submit">${editing ? 'Update' : 'Add'} Match</button>
          ${editing ? '<button type="button" id="cancelEdit">Cancel</button>' : ''}
        </form>
        <h3>Current Matches</h3>
        <ul id="adminMatchList"></ul>
      `;

      const list = document.getElementById('adminMatchList');
      list.innerHTML = '';
      window.matches.forEach((match, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `
          ${match.home} vs ${match.away} ‚Äî ${match.date}
          <button onclick="editMatch(${idx})">‚úèÔ∏è</button>
          <button onclick="deleteMatch(${idx})">‚ùå</button>
        `;
        list.appendChild(li);
      });

      document.getElementById('matchForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const matchData = {
          home: form.home.value,
          away: form.away.value,
          score: form.score.value,
          date: form.date.value,
          stadiumImg: form.stadiumImg.value,
          day: form.day.value,
          mvp: form.mvp.value,
          banned: form.banned.value
        };

        matchData.id = editingIndex !== null ? window.matches[editingIndex].id : Date.now().toString();
        const method = editingIndex !== null ? 'PUT' : 'POST';

        fetch("https://script.google.com/macros/s/AKfycbybAu3zUjcSV9_KU2_jxkoKS316lBA4S8dK2pZftbwxstWyHVk8VuGlwZaxQaH_g2FL/exec", {
          method,
          body: JSON.stringify(matchData)
        }).then(() => {
          editingIndex = null;
          loadMatchesFromAPI().then(renderAdminPanel);
        });

      });

      if (editing) {
        document.getElementById('cancelEdit').addEventListener('click', () => {
          editingIndex = null;
          renderAdminPanel();
        });
      }
    }

    function editMatch(idx) {
      editingIndex = idx;
      renderAdminPanel();
    }

    function deleteMatch(idx) {
      const id = window.matches[idx].id;
      fetch(`https://script.google.com/macros/s/AKfycbybAu3zUjcSV9_KU2_jxkoKS316lBA4S8dK2pZftbwxstWyHVk8VuGlwZaxQaH_g2FL/exec?id=${id}`, {
        method: 'DELETE'
      }).then(() => {
        loadMatchesFromAPI().then(renderAdminPanel);
      });
    }

    window.onload = async () => {
      await loadMatchesFromAPI();
      await loadPlayerStats(); // ‚¨ÖÔ∏è load player stats early


      renderStandings();
      renderMatches(); // run only after data is ready

      ['ipFilter', 'ipOperator', 'erFilter', 'erOperator', 'baaFilter', 'baaOperator'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', applySeason3Filters);
      });

      document.getElementById("Standings").classList.add("active");

      const teamRosters = {
        "Car-bones White Van": ["Bowser", "Dark Bones", "Dry Bones", "Blue Dry Bones", "Chicken", "Red Koopa Troopa", "Koopa Troopa", "Red Magikoopa", "Carby", "Red Yoshi", "Baby Mario", "Red Koopa Paratroopa", "Ice Cube", "Blooper"],
        "Kritter Town USA": ["King K Rool", "Kritter", "Blue Kritter", "Luigi", "Rizzler", "Blue Shy Guy", "Minion", "Magikoopa", "Lilo", "Toadsworth", "Matt", "Yellow Magikoopa", "Dora"],
        "Monkey Mashers": ["Donkey Kong", "Petey Piranha", "Funky Kong", "Wario", "Yoshi", "Diddy Kong", "Tiny Kong", "Tsitsipas", "Lizzy", "Frozone", "Harry Potter", "SemenLad", "Dixie Kong"],
        "Unc's Breeding Program": ["Unc", "Saddam Hussein", "Lara Croft", "Green Shy Guy", "Green Toad", "Green Magikoopa", "Peach", "Koopa Paratroopa", "Monty Mole", "Kim Jong Un", "Black Widow", "Snape", "Green Noki"],
        "Kevin G's Escort Agency": ["Birdo", "King Boo", "Daisy", "Kevin G", "Shy Guy", "Baby Daisy", "Miss Hot", "Livvy Dunne", "Dwayne Wade", "Black Shy Guy", "Pink Yoshi", "Baby Luigi", "Goomba"],
        "Trinity Triple Threat": ["Wiggler", "Red Kritter", "Brown Kritter", "Waluigi", "Lebron James", "Borat", "Yellow Shy Guy", "Trinity", "Yellow Pianta", "The Penguin", "Lil Wayne", "KSI"],
        "Toadette's Hit List": ["Fire Bro", "Boomerang Bro", "Red Pianta", "Mario", "Toad", "Blue Toad", "Toadette", "Purple Toad", "Mr. Incredible", "Baby Peach", "Blue Yoshi", "Handsome Squidward", "Light Blue Yoshi"],
        BenT: ["Bowser Jr", "Hammer Bro", "Green Dry Bones", "Pianta", "Yellow Toad", "Boo", "Mikasa", "Baby DK", "Paragoomba", "Big AJ", "Yellow Yoshi", "Captain Jack", "MJ HeeHee"]
      };

      const teamGrid = document.getElementById('teamCharacterGrid');
      const allCharacters = window.characters || [];

      function renderTeam(team) {
        document.getElementById('teamMatchGrid').innerHTML = '';
        document.getElementById('teamMatchesHeader').textContent = '';
        teamGrid.innerHTML = '';
        const roster = teamRosters[team];
        const teamCharacters = roster.map(name => {
          const char = allCharacters.find(char => char.name === name);
          if (!char) {
            console.warn(`Character not found for: ${name}`);
            return null;
          }
          const stats = window.playerStats?.[char.name.toLowerCase()];
          if (!stats) console.log(`Missing stats for: ${char.name}`);
          return { ...char, stats };
        }).filter(Boolean);


        teamCharacters.forEach(char => {
          const card = document.createElement('div');
          const isCaptain = window.captains?.includes(char.name);
          card.className = 'character-card' + (isCaptain ? ' captain-card' : '');
          card.setAttribute('data-class', char.class || '');
          card.setAttribute('data-avg', char.stats?.AVG ?? 0);
          card.setAttribute('data-hr', char.stats?.HR ?? 0);
          card.setAttribute('data-gp', char.stats?.GP ?? 0);

          const miiInfo = window.miiMeta?.[char.name];
          const badge = miiInfo ? `<div class="mii-badge" style="background-color:${miiInfo.color};">${miiInfo.gender}</div>` : '';

          const mvpCount = window.mvpS3Counts?.[char.name];
          const mvpBadge = mvpCount
            ? `<div class="mvp-badge">${mvpCount}‚≠ê</div>`
            : '';



          card.innerHTML = `
            ${badge}
            ${mvpBadge}
            <img src="${char.image}" alt="${char.name}">
            <h3>${char.name}</h3>
            <p>Class: ${char.class}</p>
            ${char.stats ? `
              <div class="char-stat">AVG: ${char.stats.AVG || '0'}</div>
              <div class="char-stat">HR: ${char.stats.HR || '0'}</div>
              <div class="char-stat">GP: ${char.stats.GP || '0'}</div>
              <div class="char-stat">IP: ${char.stats.IP || '0'}</div>
              <div class="char-stat">ERA: ${char.stats.ER || '0'}</div>
              <div class="char-stat">BAA: ${char.stats.BAA || '0'}</div>
            ` : `<div class="placeholder-stats">No Games Played</div>`}
          `;

          teamGrid.appendChild(card);
          
        });

        // RENDER MATCHES FOR THIS TEAM
        const matchGrid = document.getElementById('teamMatchGrid');
        const matchHeader = document.getElementById('teamMatchesHeader');
        const teamMatches = window.matches.filter(m => m.home === team || m.away === team);

        if (teamMatches.length === 0) {
          matchHeader.textContent = `No games played by ${team} yet.`;
          matchGrid.innerHTML = '';
        } else {
          matchHeader.textContent = `${team}'s Games`;
          matchGrid.innerHTML = '';

          teamMatches.forEach(match => {
            const card = document.createElement('div');
            card.className = 'match-card';

            card.innerHTML = `
              <img src="${match.stadiumImg}" alt="Stadium">
              ${match.day ? `<div class="stadium-time-label ${match.day.toLowerCase()}">${match.day}</div>` : ''}
              <div class="banned">${match.banned} Banned</div>
              <div class="teams vertical">
                <span>${match.home}</span>
                <div class="vs-text">vs</div>
                <span>${match.away}</span>
              </div>
              <div class="score">${match.score || 'TBD'}</div>
              <div class="time">${match.date}</div>
              ${match.mvp ? `<div class="match-mvp">MVP: ${match.mvp}</div>` : ''}

              <div class="match-stats-container">
                <button class="toggle-stats-btn">üìä View Stats</button>
                <div class="team-stat-box" style="display: none;">
                  <div class="team-stat home">
                    <strong>${match.home}</strong><br><br>
                    <div class="stat-block">
                      <span class="stat-label">Stat Adj:</span><br>
                      ${formatMultiline(match.homeStatAdjust)}
                    </div>
                    <div class="stat-block">
                      <span class="stat-label">Trajectory:</span><br>
                      ${formatMultiline(match.homeTrajectory)}
                    </div>
                    <div class="stat-block">
                      <span class="stat-label">Class:</span><br>
                      ${formatMultiline(match.homeClass)}
                    </div>
                    <div class="stat-block">
                      <span class="stat-label">Star:</span><br>
                      <span class="star-player">${match.homeStar}</span>
                    </div>
                  </div>

                  <hr class="stat-divider">

                  <div class="team-stat away">
                    <strong>${match.away}</strong><br><br>
                    <div class="stat-block">
                      <span class="stat-label">Stat Adj:</span><br>
                      ${formatMultiline(match.awayStatAdjust)}
                    </div>
                    <div class="stat-block">
                      <span class="stat-label">Trajectory:</span><br>
                      ${formatMultiline(match.awayTrajectory)}
                    </div>
                    <div class="stat-block">
                      <span class="stat-label">Class:</span><br>
                      ${formatMultiline(match.awayClass)}
                    </div>
                    <div class="stat-block">
                      <span class="stat-label">Star:</span><br>
                      <span class="star-player">${match.awayStar}</span>
                    </div>
                  </div>
                </div>
              </div>
            `;

            // Add WIN/LOSS overlay
            const [homeScore, awayScore] = match.score?.split('-').map(s => parseInt(s.trim())) || [0, 0];
            let resultText = '';

            if (homeScore !== 0 || awayScore !== 0) {
              const isHome = match.home === team;
              const isAway = match.away === team;
              
              if (isHome && homeScore > awayScore) resultText = 'WON';
              else if (isHome && homeScore < awayScore) resultText = 'LOST';
              else if (isAway && awayScore > homeScore) resultText = 'WON';
              else if (isAway && awayScore < homeScore) resultText = 'LOST';
            }

            if (resultText) {
              const overlay = document.createElement('div');
              overlay.className = `result-overlay ${resultText === 'WON' ? 'won' : 'lost'}`;
              overlay.textContent = resultText;
              card.appendChild(overlay);
            }


            matchGrid.appendChild(card);
          });
        }
        document.querySelectorAll('.toggle-stats-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const statsBox = btn.nextElementSibling;
            const isVisible = statsBox.style.display === 'block';
            statsBox.style.display = isVisible ? 'none' : 'block';
            btn.textContent = isVisible ? 'üìä View Stats' : 'üìâ Hide Stats';
          });
        });
      }

      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          const activeTab = document.querySelector(".tab.active");
          if (activeTab) activeTab.classList.remove("active");
          tab.classList.add("active");

          document.querySelectorAll(".season-content").forEach(s => s.classList.remove("active"));
          const tabName = tab.dataset.team;
          if (tabName === "Standings") {
            renderStandings();
            document.getElementById("Standings").classList.add("active");
          } else if (tabName === "Season3Stats") {
            renderSeason3Stats();
            document.getElementById("Season3Stats").classList.add("active");
          } else if (tabName === "Matches") {
            renderMatches();
            document.getElementById("Matches").classList.add("active");
          } else {
            renderTeam(tabName);
            document.getElementById("Teams").classList.add("active");
          }

        });
      });
    };



    function renderStandings() {
      const body = document.getElementById('season3-standings-body');
      body.innerHTML = '';

      const standings = calculateStandingsFromMatches(window.matches);
      const sorted = standings.sort((a, b) => {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return b.diff - a.diff;
      });

      sorted.forEach((team, i) => {
        const row = document.createElement('tr');
        if (i === 0) row.classList.add('gold-glow');
        else if (i === 1) row.classList.add('gold-glow');
        else if (i >= 2 && i <= 5) row.classList.add('green-glow');
        else if (i >= sorted.length - 2) row.classList.add('red-glow');

        const pct = (team.wins / (team.wins + team.losses)).toFixed(3);

        row.innerHTML = `
          <td>${team.team}</td>
          <td>${team.wins}</td>
          <td>${team.losses}</td>
          <td>${pct}</td>
          <td>${team.diff > 0 ? '+' : ''}${team.diff}</td>
          <td>${team.streakFormatted}</td>
          <td>${team.homeWins}</td>
          <td>${team.awayWins}</td>
        `;


        body.appendChild(row);
      });
    }

    function formatMultiline(input) {
      if (!input) return '‚Äî';
      const lines = input.split(/\r?\n/).filter(Boolean);
      return lines.map((line, i) => `${i + 1}) ${line}`).join('<br>');
    }


    function renderMatches() {
      const matchList = document.getElementById('matchList');
      matchList.innerHTML = '';

      window.matches.forEach(match => {
        const card = document.createElement('div');
        card.className = 'match-card';
        card.innerHTML = `
          <img src="${match.stadiumImg}" alt="Stadium">
          ${match.day ? `<div class="stadium-time-label ${match.day.toLowerCase()}">${match.day}</div>` : ''}
          <div class="banned">${match.banned} Banned</div>
          <div class="teams vertical">
            <span>${match.home}</span>
            <div class="vs-text">vs</div>
            <span>${match.away}</span>
          </div>
          <div class="score">${match.score || 'TBD'}</div>
          <div class="time">${match.date}</div>
          ${match.mvp ? `<div class="match-mvp">MVP: ${match.mvp}</div>` : ''}
          
          <div class="match-stats-container">
            <button class="toggle-stats-btn">üìä View Stats</button>
            <div class="team-stat-box" style="display: none;">
              <div class="team-stat home">
                <strong>${match.home}</strong><br><br>
                <div class="stat-block">
                  <span class="stat-label">Stat Adj:</span><br>
                  ${formatMultiline(match.homeStatAdjust)}
                </div>
                <div class="stat-block">
                  <span class="stat-label">Trajectory:</span><br>
                  ${formatMultiline(match.homeTrajectory)}
                </div>
                <div class="stat-block">
                  <span class="stat-label">Class:</span><br>
                  ${formatMultiline(match.homeClass)}
                </div>
                <div class="stat-block">
                  <span class="stat-label">Star:</span><br>
                  <span class="star-player">${match.homeStar}</span>
                </div>
              </div>

              <hr class="stat-divider">

              <div class="team-stat away">
                <strong>${match.away}</strong><br><br>
                <div class="stat-block">
                  <span class="stat-label">Stat Adj:</span><br>
                  ${formatMultiline(match.awayStatAdjust)}
                </div>
                <div class="stat-block">
                  <span class="stat-label">Trajectory:</span><br>
                  ${formatMultiline(match.awayTrajectory)}
                </div>
                <div class="stat-block">
                  <span class="stat-label">Class:</span><br>
                  ${formatMultiline(match.awayClass)}
                </div>
                <div class="stat-block">
                  <span class="stat-label">Star:</span><br>
                  <span class="star-player">${match.awayStar}</span>
                </div>
              </div>
            </div>
          </div>


        `;

        matchList.appendChild(card);
      });
      document.querySelectorAll('.toggle-stats-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const statsBox = btn.nextElementSibling;
            const isVisible = statsBox.style.display === 'block';
            statsBox.style.display = isVisible ? 'none' : 'block';
            btn.textContent = isVisible ? 'üìä View Stats' : 'üìâ Hide Stats';
          });
      });
    }
  </script>

  <!-- Standings Content -->
  <div class="season-content" id="Standings">
    <h3>Season 3 Standings</h3>
    <table class="standings-table">
      <thead>
        <tr>
          <th>Team</th>
          <th>W</th>
          <th>L</th>
          <th>PCT</th>
          <th>Diff</th>
          <th>Streak</th>
          <th>Home W</th>
          <th>Away W</th>
        </tr>
      </thead>
      <tbody id="season3-standings-body">
        <!-- Filled dynamically -->
      </tbody>
    </table>
  </div>


  <!-- Season 3 Stats Content -->
  <div class="season-content" id="Season3Stats">
    <div class="filter-container">
      <label for="classFilter">Class:</label>
      <select id="classFilter">
        <option value="">All</option>
        <option value="Power">Power</option>
        <option value="Speed">Speed</option>
        <option value="Technique">Technique</option>
        <option value="Balanced">Balanced</option>
      </select>
      
      <div id="battingFilters">
        <label for="avgFilter">Batting Avg:</label>
        <select id="avgOperator">
          <option value=">">Above</option>
          <option value="<">Below</option>
        </select>
        <input type="number" id="avgFilter" step="0.001" placeholder="e.g. 0.300" />
      
        <label for="gpFilter">Games Played:</label>
        <select id="gpOperator">
          <option value=">">More than</option>
          <option value="<">Less than</option>
        </select>
        <input type="number" id="gpFilter" placeholder="e.g. 10" />
      
        <label for="gamesFilter">Home Runs:</label>
        <select id="gamesOperator">
          <option value=">">More than</option>
          <option value="<">Less than</option>
        </select>
        <input type="number" id="gamesFilter" placeholder="e.g. 10" />
      </div>

      <div id="pitchingFilters" style="display: none;">
        <label for="ipFilter">Innings Pitched:</label>
        <select id="ipOperator">
          <option value=">">More than</option>
          <option value="<">Less than</option>
        </select>
        <input type="number" id="ipFilter" step="0.1" placeholder="e.g. 10" />
      
        <label for="erFilter">Earned Run Average:</label>
        <select id="erOperator">
          <option value=">">More than</option>
          <option value="<">Less than</option>
        </select>
        <input type="number" id="erFilter" step="1" placeholder="e.g. 5" />
      
        <label for="baaFilter">BAA:</label>
        <select id="baaOperator">
          <option value=">">Above</option>
          <option value="<">Below</option>
        </select>
        <input type="number" id="baaFilter" step="0.001" placeholder="e.g. 0.300" />
      </div>
      
      <button onclick="resetSeason3Filters()">Reset Filters</button>

      <div class="sort-container" style="margin-top: 1rem;">
        <label for="sortOption">Sort By:</label>
        <select id="sortOption">
          <option value="">-- Select --</option>
          <option value="games">Home Runs</option>
          <option value="gp">Games Played</option>
          <option value="avg">Batting Average</option>
        </select>
      </div>
      <div class="toggle-container">
        <button id="toggleStatsBtn">Switch to Pitching Stats</button>
      </div>

      <div class="team-filter-container" style="margin-top: 1rem;">
        <label for="teamFilter">Team:</label>
        <select id="teamFilter">
          <option value="">All Teams</option>
          <option value="Car-bones White Van">Car-bones White Van</option>
          <option value="Kritter Town USA">Kritter Town USA</option>
          <option value="Monkey Mashers">Monkey Mashers</option>
          <option value="Unc's Breeding Program">Unc's Breeding Program</option>
          <option value="Kevin G's Escort Agency">Kevin G's Escort Agency</option>
          <option value="Trinity Triple Threat">Trinity Triple Threat</option>
          <option value="Toadette's Hit List">Toadette's Hit List</option>
          <option value="BenT">BenT</option>
        </select>
      </div>
    </div>

    <div class="character-grid" id="season3StatsGrid">
      <!-- Character cards will be inserted here -->
    </div>
  </div>

  <!-- Matches Content -->
  <div id="loading-matches" class="spinner" style="display:none; text-align:center;">Loading...</div>

  
  <div class="season-content" id="Matches">
    <h3>Upcoming & Completed Matches</h3>
    <div id="matchList" class="character-grid match-grid">
      <!-- Match cards will be inserted here -->
    </div>
  </div>

</body>
</html>
